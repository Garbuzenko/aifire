import mysql from 'mysql2/promise';
import dotenv from 'dotenv';

dotenv.config();

const KEYWORD_MAPPING: { [key: string]: string } = {
  // IT
  'разработчик': 'Информационные технологии',
  'программист': 'Информационные технологии',
  'developer': 'Информационные технологии',
  'programmer': 'Информационные технологии',
  'java': 'Информационные технологии',
  'python': 'Информационные технологии',
  'php': 'Информационные технологии',
  'frontend': 'Информационные технологии',
  'backend': 'Информационные технологии',
  'fullstack': 'Информационные технологии',
  'devops': 'Информационные технологии',
  'qa': 'Информационные технологии',
  'tester': 'Информационные технологии',
  'тестировщик': 'Информационные технологии',
  'системный администратор': 'Информационные технологии',
  'admin': 'Информационные технологии',
  'data scientist': 'Информационные технологии',
  'аналитик': 'Информационные технологии',
  'product manager': 'Информационные технологии',
  'project manager': 'Информационные технологии',
  'aqa': 'Информационные технологии',
  'dev-ops': 'Информационные технологии',
  '1с': 'Информационные технологии',
  '1c': 'Информационные технологии',
  'it': 'Информационные технологии',
  'ai': 'Информационные технологии',
  'ml': 'Информационные технологии',
  'software': 'Информационные технологии',
  'web': 'Информационные технологии',
  'game': 'Информационные технологии',
  'android': 'Информационные технологии',
  'ios': 'Информационные технологии',
  
  // Sales
  'продаж': 'Продажи, обслуживание клиентов',
  'sales': 'Продажи, обслуживание клиентов',
  'продавец': 'Розничная торговля',
  'кассир': 'Розничная торговля',
  'торговый': 'Продажи, обслуживание клиентов',
  
  // Finance
  'бухгалтер': 'Финансы, бухгалтерия',
  'accountant': 'Финансы, бухгалтерия',
  'экономист': 'Финансы, бухгалтерия',
  'финанс': 'Финансы, бухгалтерия',
  'auditor': 'Финансы, бухгалтерия',
  
  // Legal
  'юрист': 'Юристы',
  'lawyer': 'Юристы',
  'адвокат': 'Юристы',
  'нотариус': 'Юристы',
  
  // HR
  'hr': 'Управление персоналом, тренинги',
  'рекрутер': 'Управление персоналом, тренинги',
  'recruiter': 'Управление персоналом, тренинги',
  'кадры': 'Управление персоналом, тренинги',
  'персонал': 'Управление персоналом, тренинги',
  
  // Marketing/Arts
  'маркетолог': 'Маркетинг, реклама, PR',
  'marketing': 'Маркетинг, реклама, PR',
  'pr': 'Маркетинг, реклама, PR',
  'реклама': 'Маркетинг, реклама, PR',
  'smm': 'Маркетинг, реклама, PR',
  'seo': 'Маркетинг, реклама, PR',
  'copywriter': 'Маркетинг, реклама, PR',
  'копирайтер': 'Маркетинг, реклама, PR',
  'дизайнер': 'Искусство, развлечения, массмедиа',
  'designer': 'Искусство, развлечения, массмедиа',
  'художник': 'Искусство, развлечения, массмедиа',
  'artist': 'Искусство, развлечения, массмедиа',
  'актер': 'Искусство, развлечения, массмедиа',
  'actor': 'Искусство, развлечения, массмедиа',
  'поэт': 'Искусство, развлечения, массмедиа',
  'писатель': 'Искусство, развлечения, массмедиа',
  'музыкант': 'Искусство, развлечения, массмедиа',
  
  // Transport
  'водитель': 'Транспорт, логистика, перевозки',
  'driver': 'Транспорт, логистика, перевозки',
  'логист': 'Транспорт, логистика, перевозки',
  'logistics': 'Транспорт, логистика, перевозки',
  'курьер': 'Транспорт, логистика, перевозки',
  'экспедитор': 'Транспорт, логистика, перевозки',
  'такси': 'Транспорт, логистика, перевозки',
  
  // Production/Blue collar
  'инженер': 'Производство, сервисное обслуживание',
  'engineer': 'Производство, сервисное обслуживание',
  'слесарь': 'Рабочий персонал',
  'сварщик': 'Рабочий персонал',
  'электрик': 'Рабочий персонал',
  'механик': 'Рабочий персонал',
  'строитель': 'Строительство, недвижимость',
  'прораб': 'Строительство, недвижимость',
  'рабочий': 'Рабочий персонал',
  'буровик': 'Добыча сырья',
  'нефть': 'Добыча сырья',
  'газ': 'Добыча сырья',
  
  // Management
  'директор': 'Высший и средний менеджмент',
  'director': 'Высший и средний менеджмент',
  'ceo': 'Высший и средний менеджмент',
  'cto': 'Высший и средний менеджмент',
  'руководитель': 'Высший и средний менеджмент',
  'основатель': 'Высший и средний менеджмент',
  'founder': 'Высший и средний менеджмент',
  
  // Security
  'охранник': 'Безопасность',
  'security': 'Безопасность',
  'полицейский': 'Безопасность',
  'военный': 'Безопасность',
  
  // Education/Science
  'учитель': 'Наука, образование',
  'teacher': 'Наука, образование',
  'преподаватель': 'Наука, образование',
  'профессор': 'Наука, образование',
  'ученый': 'Наука, образование',
  'scientist': 'Наука, образование',
  
  // Medicine
  'врач': 'Медицина, фармацевтика',
  'doctor': 'Медицина, фармацевтика',
  'медсестра': 'Медицина, фармацевтика',
  'nurse': 'Медицина, фармацевтика',
  'хирург': 'Медицина, фармацевтика',
  
  // Politics (censored or specific)
  'депутат': 'Государственная служба',
  'политик': 'Государственная служба',
  'президент': 'Государственная служба',
  'министр': 'Государственная служба',
  
  // Additional from round 2
  'сантехник': 'Рабочий персонал',
  'журналист': 'Искусство, развлечения, массмедиа',
  'повар': 'Туризм, гостиницы, рестораны',
  'сисадмин': 'Информационные технологии',
  'методолог': 'Управление персоналом, тренинги',
  'проктолог': 'Медицина, фармацевтика',
  'поддержка': 'Информационные технологии',
  'support': 'Информационные технологии',
  'безопасность': 'Безопасность',
  'проджект': 'Информационные технологии',
  'продукт': 'Информационные технологии', // Product manager
  // 'ит': 'Информационные технологии', // REMOVED: matches too many words
  'менеджер': 'Высший и средний менеджмент', // Generic manager
  
  // Round 3 additions
  'ops': 'Информационные технологии',
  'product owner': 'Информационные технологии',
  'team lead': 'Информационные технологии',
  'тим лид': 'Информационные технологии',
  'сетевой': 'Информационные технологии',
  'network': 'Информационные технологии',
  'фронтенд': 'Информационные технологии',
  'програмист': 'Информационные технологии',
  'delphi': 'Информационные технологии',
  'сайт': 'Информационные технологии',
  'site': 'Информационные технологии',
  'full stack': 'Информационные технологии',
  'head of it': 'Информационные технологии',
  'solution architect': 'Информационные технологии',
  'архитектор решений': 'Информационные технологии',
  'архитектор ис': 'Информационные технологии',
  'twitch': 'Искусство, развлечения, массмедиа',
  'streamer': 'Искусство, развлечения, массмедиа',
  'drone': 'Информационные технологии',
  'prompt': 'Информационные технологии',
  'program manager': 'Информационные технологии',
  'bitrix': 'Информационные технологии',
  'chatgpt': 'Информационные технологии',
  'чат gpt': 'Информационные технологии',
  'плиточник': 'Строительство, недвижимость',
  'фитнес': 'Управление персоналом, тренинги',
  'тренер': 'Управление персоналом, тренинги',
  'воспитатель': 'Наука, образование',
  'аудитор': 'Финансы, бухгалтерия',
  'политолог': 'Наука, образование',
  
  // Round 4
  'безопасности': 'Безопасность',
  'методист': 'Наука, образование',
  'землекоп': 'Рабочий персонал',
  'работяга': 'Рабочий персонал',
  'cpo': 'Высший и средний менеджмент',
  'поддерж': 'Информационные технологии',
  'engin': 'Производство, сервисное обслуживание', // Catch typos like enginiirering
};

const CENSORED_KEYWORDS = [
  'fuck', 'shit', 'bitch', 'ass', 'sex', 'porn', 'whore', 'slut', 'dick', 'cock', 'pussy', 'cunt',
  'хуй', 'пизда', 'ебать', 'блять', 'сука', 'мудак', 'говно', 'жопа', 'член', 'хер', 'манда', 'залупа',
  'порно', 'секс'
];

async function fixProfessionAnalysis() {
  const connection = await mysql.createConnection({
    host: process.env.DB_HOST,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_NAME,
    port: Number(process.env.DB_PORT),
  });

  try {
    console.log('Connected to database.');

    // 1. Fix specific incorrect rows
    // "politician" ID 1000043
    await connection.execute('UPDATE profession_analysis SET prof_type = ? WHERE id = ?', ['Государственная служба', 1000043]);
    console.log('Fixed politician (ID 1000043)');

    // "дурак" ID 35
    await connection.execute('UPDATE profession_analysis SET prof_type = NULL WHERE id = ?', [35]);
    console.log('Fixed дурак (ID 35)');

    // 2. Process all rows
    const [rows] = await connection.execute('SELECT id, profession, is_censored, prof_type FROM profession_analysis');
    
    let updatedCount = 0;
    let censoredCount = 0;

    for (const row of (rows as any[])) {
      const professionLower = row.profession.toLowerCase();
      let newProfType = row.prof_type;
      let newIsCensored = row.is_censored;
      let needsUpdate = false;

      // Check censorship
      for (const badWord of CENSORED_KEYWORDS) {
        if (professionLower.includes(badWord)) {
          // Exception for "парикмахер" and "хер"
          if (badWord === 'хер' && professionLower.includes('парикмахер')) continue;
          
          if (newIsCensored !== 1) {
            newIsCensored = 1;
            needsUpdate = true;
            console.log(`Censoring: ${row.profession}`);
          }
          // If censored, prof_type should ideally be null or consistent. 
          // But if it's "sex worker", maybe it has a type? 
          // For now, let's leave prof_type alone if censored, or set to null if it was missing.
          break;
        }
      }

      // If not censored and missing prof_type, try to guess
      if (!newIsCensored && !newProfType) {
        for (const [keyword, type] of Object.entries(KEYWORD_MAPPING)) {
          if (professionLower.includes(keyword)) {
            newProfType = type;
            needsUpdate = true;
            console.log(`Guessed type for ${row.profession}: ${type}`);
            break;
          }
        }
      }

      if (needsUpdate) {
        await connection.execute(
          'UPDATE profession_analysis SET is_censored = ?, prof_type = ? WHERE id = ?',
          [newIsCensored, newProfType, row.id]
        );
        updatedCount++;
      }
    }

    console.log(`Updated ${updatedCount} rows.`);

  } catch (error) {
    console.error('Error:', error);
  } finally {
    await connection.end();
  }
}

fixProfessionAnalysis();
